name: Deploy to cPanel via SSH

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, bcmath, zip
          coverage: none

      - name: üì¶ Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: üõ†Ô∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install NPM Dependencies & Build
        run: |
          npm install
          npm run build

      - name: üìÇ Deploy via SSH
        uses: easingthemes/ssh-deploy@v5.1.0
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-rlgoDzvc -i --delete"
          SOURCE: "./"
          REMOTE_HOST: "64.120.94.82"
          REMOTE_USER: ${{ secrets.SSH_USERNAME }}
          TARGET: ${{ secrets.REMOTE_TARGET }}
          EXCLUDE: |
            "/.git/"
            "/.github/"
            "/node_modules/"
            "/tests/"
            ".env"
            ".env.example"
            ".editorconfig"
            ".gitattributes"
            "composer.json"
            "composer.lock"
            "package.json"
            "package-lock.json"
            "vite.config.js"
            "postcss.config.js"
            "tailwind.config.js"
            "README.md"
            "TECHNICAL_DOCS.md"
            "phpunit.xml"
            "docker-compose.yml"
            "/storage/framework/cache/"
            "/storage/framework/sessions/"
            "/storage/framework/views/"
            "/storage/logs/"
