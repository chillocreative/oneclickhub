name: Deploy to cPanel via SSH

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, bcmath, zip
          coverage: none

      - name: üì¶ Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: üõ†Ô∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install NPM Dependencies & Build
        run: |
          npm install
          npm run build

      - name:  Set up SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üìÇ Deploy via Rsync
        run: |
          rsync -rlgoDzvc --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude '/.git/' \
            --exclude '/.github/' \
            --exclude '/node_modules/' \
            --exclude '/tests/' \
            --exclude '.env' \
            --exclude '.env.example' \
            --exclude '.editorconfig' \
            --exclude '.gitattributes' \
            --exclude 'composer.json' \
            --exclude 'composer.lock' \
            --exclude 'package.json' \
            --exclude 'package-lock.json' \
            --exclude 'vite.config.js' \
            --exclude 'postcss.config.js' \
            --exclude 'tailwind.config.js' \
            --exclude 'README.md' \
            --exclude 'TECHNICAL_DOCS.md' \
            --exclude 'phpunit.xml' \
            --exclude 'docker-compose.yml' \
            --exclude '/storage/framework/cache/' \
            --exclude '/storage/framework/sessions/' \
            --exclude '/storage/framework/views/' \
            --exclude '/storage/logs/' \
            ./ chilloc1@64.120.94.82:${{ secrets.REMOTE_TARGET }}
